#!/usr/bin/env bash

pattern="${1:-"colemick"}"
	list="$(\
		az group list \
			--output tsv \
			--query "[?tags.colemickpermanent != 'true' && contains(name, '${pattern}') && properties.provisioningState != 'Deleting'].name")"

	if which parallel; then
		printf "${list}" | parallel 'printf "Will delete: %s\n" {}'
	else
		echo "Will delete ${list}"
	fi
	printf "Are you sure? [y/N] "
	read -r response
	if [[ "${response:l}" =~ ^(yes|y)$ ]]; then
		if which parallel ; then
			printf "${list}" | parallel 'printf "Deleting %s\n" {} && az group delete --no-wait --yes --name {}'
		else
			echo "${list}"| while IFS= read -r line ; do az group delete --no-wait --yes --name "${line}"; done
		fi
	fi