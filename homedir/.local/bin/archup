#!/usr/bin/env bash

set -x
set -e

PACKAGES=(zsh tmux mosh openssh vim stow wget curl htop docker \
    git subversion mercurial \
    go python ruby perl rustup npm nodejs \
    jq tig parallel weechat gist fzf python-pip rsync reflector \
    asciinema bind-tools weechat mitmproxy \
    libu2f-host \
    neovim sshfs \
	yaourt)
VIRT=(libvirt qemu ebtables dnsmasq)
CLOUD=(kubectl-bin kubernetes-helm aws-cli)
PIP_PACKAGES=(azure-cli shreddit)

_arch_bootstrap() {
	chktool=$1
	shift 1
	if ! which $chktool ; then
		gpg --recv-keys --keyserver hkp://pgp.mit.edu 1EB2638FF56C0C53

		# pacaur dependencies
		#sudo pacman -S curl sudo git perl expac yajl --needed --noconfirm

		# extra args are deps, so install those first, then the tool
		for pkg in "${@}" "$chktool"
		do
			mkdir /tmp/$pkg
			chmod 0777 /tmp/$pkg
			(
				cd /tmp/$pkg
				curl "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=${pkg}" > PKGBUILD
				makepkg -s --noconfirm
				# wildcards for version, and for package suffix depending on if I turn off needless compression
				sudo pacman -U ./$pkg*.pkg.tar* --noconfirm
			)
			rm -rf /tmp/$pkg
		done
	fi
}

set -x
_arch_bootstrap yaourt package-query

yaourt -S --needed --noconfirm ${PACKAGES[@]} ${VIRT[@]} ${CLOUD[@]}
yaourt -Syua --noconfirm

pip install --user --upgrade ${PIP_PACKAGES[@]}

sudo systemctl enable docker libvirtd
sudo systemctl start docker libvirtd

sudo gpasswd -a "${USER}" libvirt
sudo gpasswd -a "${USER}" kvm
sudo gpasswd -a "${USER}" docker

curl 'https://raw.githubusercontent.com/ahmetb/goclone/master/goclone' > $HOME/.local/bin/goclone
chmod +x $HOME/.local/bin/goclone

